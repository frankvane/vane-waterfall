这是一个非常有前瞻性的问题！让我先分析一下现有的懒加载插件系统，然后为你设计一个瀑布流的插件化方案。

[3 tools called]

非常好的思路！基于现有的懒加载插件化架构，完全可以构建一个瀑布流插件系统。让我为你设计一个完整的方案：

## 📐 瀑布流插件化架构设计

### 1️⃣ **核心组件：WaterfallCore**

```typescript
// WaterfallCore.tsx - 极简核心组件

interface WaterfallCoreProps<T = any> {
  // 数据源
  items: T[];
  renderItem: (item: T, index: number) => React.ReactNode;

  // 布局配置
  columns?: number; // 列数（可由插件动态计算）
  gap?: number; // 间距

  // 容器配置
  containerStyle?: React.CSSProperties;
  containerClassName?: string;

  // 生命周期钩子（由插件注入）
  onItemMount?: (index: number, element: HTMLElement) => void;
  onItemUnmount?: (index: number) => void;
  onLayoutComplete?: (columnHeights: number[]) => void;
  onScroll?: (scrollTop: number, scrollHeight: number) => void;
  onResize?: (width: number, height: number) => void;

  // 供 HOC 传入的外部引用
  containerRefExternal?: React.RefObject<HTMLDivElement | null>;
  itemRefsExternal?: React.MutableRefObject<Map<number, HTMLElement>>;
}

interface WaterfallCoreRef {
  relayout: () => void; // 重新布局
  scrollToItem: (index: number) => void; // 滚动到指定项
  getItemPosition: (index: number) => { x: number; y: number } | null;
  getColumnHeights: () => number[];
}

// 核心职责：
// 1. 维护基础的瀑布流布局算法
// 2. 管理 item 位置计算
// 3. 提供 DOM 引用和状态
// 4. 触发生命周期钩子供插件响应
```

### 2️⃣ **插件类型定义**

```typescript
// plugins/types.ts

export interface WaterfallPluginContext<T = any> {
  // 基础数据
  items: T[];
  containerRef: React.RefObject<HTMLDivElement | null>;
  itemRefs: Map<number, HTMLElement>;

  // 布局信息
  columns: number;
  gap: number;
  columnHeights: number[];
  itemPositions: Map<
    number,
    { x: number; y: number; width: number; height: number }
  >;

  // 视口信息
  containerWidth: number;
  containerHeight: number;
  scrollTop: number;
  scrollHeight: number;

  // 配置
  props: WaterfallCoreProps<T>;

  // 插件通信
  bus?: PluginBus;
  sharedData?: Map<string, any>;

  // 性能数据
  performanceData?: {
    layoutStartTime: number;
    layoutEndTime?: number;
    duration?: number;
    itemCount: number;
  };
}

export interface WaterfallPluginHooks<T = any> {
  // 生命周期钩子
  onMount?: (context: WaterfallPluginContext<T>) => void | (() => void);
  onUnmount?: (context: WaterfallPluginContext<T>) => void;

  // 布局钩子
  onBeforeLayout?: (
    context: WaterfallPluginContext<T>
  ) => boolean | Promise<boolean>;
  onLayout?: (context: WaterfallPluginContext<T>) => void;
  onLayoutComplete?: (context: WaterfallPluginContext<T>) => void;

  // 列数计算钩子（响应式插件会用到）
  calculateColumns?: (context: WaterfallPluginContext<T>) => number | undefined;

  // Item 钩子
  onItemMount?: (
    context: WaterfallPluginContext<T>,
    index: number,
    element: HTMLElement
  ) => void;
  onItemUnmount?: (context: WaterfallPluginContext<T>, index: number) => void;
  onItemEnterViewport?: (
    context: WaterfallPluginContext<T>,
    index: number
  ) => void;
  onItemLeaveViewport?: (
    context: WaterfallPluginContext<T>,
    index: number
  ) => void;

  // 交互钩子
  onScroll?: (context: WaterfallPluginContext<T>, scrollTop: number) => void;
  onResize?: (
    context: WaterfallPluginContext<T>,
    width: number,
    height: number
  ) => void;

  // 数据钩子
  onItemsChange?: (
    context: WaterfallPluginContext<T>,
    oldItems: T[],
    newItems: T[]
  ) => void;
  onLoadMore?: (
    context: WaterfallPluginContext<T>
  ) => Promise<T[]> | T[] | void;

  // 渲染钩子
  renderOverlay?: (context: WaterfallPluginContext<T>) => React.ReactNode;
  renderItemWrapper?: (
    context: WaterfallPluginContext<T>,
    index: number,
    children: React.ReactNode
  ) => React.ReactNode;

  // Props 转换
  transformProps?: (props: WaterfallCoreProps<T>) => WaterfallCoreProps<T>;
}

export interface WaterfallPlugin<T = any> {
  name: string;
  version?: string;
  hooks: WaterfallPluginHooks<T>;
  config?: Record<string, any>;
  init?: () => void | Promise<void>;
  destroy?: () => void | Promise<void>;
}
```

### 3️⃣ **基础插件分类**

#### 📊 **布局与响应式（5 个）**

```typescript
// 1. ResponsiveColumnsPlugin - 响应式列数
createResponsiveColumnsPlugin({
  breakpoints: {
    sm: { width: 640, columns: 2 },
    md: { width: 768, columns: 3 },
    lg: { width: 1024, columns: 4 },
    xl: { width: 1280, columns: 5 },
  },
});

// 2. AutoColumnPlugin - 根据容器宽度自动计算列数
createAutoColumnPlugin({
  minColumnWidth: 200, // 每列最小宽度
  maxColumns: 6,
});

// 3. FixedHeightPlugin - 固定高度布局（Grid模式）
createFixedHeightPlugin({
  itemHeight: 300,
});

// 4. GapPlugin - 动态间距
createGapPlugin({
  horizontal: 16,
  vertical: 16,
  responsive: {
    sm: 8,
    md: 12,
    lg: 16,
  },
});

// 5. AlignmentPlugin - 对齐策略
createAlignmentPlugin({
  mode: "shortest" | "balanced" | "sequential", // 最短列/平衡/顺序
});
```

#### ⚡ **性能优化（8 个）**

```typescript
// 6. VirtualScrollPlugin - 虚拟滚动
createVirtualScrollPlugin({
  overscan: 3, // 上下预渲染项数
  estimateItemHeight: 300,
});

// 7. LazyLoadPlugin - 懒加载（集成现有的 LazyLoadImage）
createLazyLoadPlugin({
  rootMargin: "200px",
  placeholder: <Skeleton />,
});

// 8. PreloadPlugin - 预加载
createPreloadPlugin({
  preloadCount: 10, // 预加载下方N项
  preloadOnIdle: true,
});

// 9. CachePlugin - 布局缓存
createCachePlugin({
  cacheKey: "waterfall-layout",
  ttl: 3600000, // 1小时
});

// 10. ThrottlePlugin - 滚动/Resize 节流
createThrottlePlugin({
  scroll: 100, // ms
  resize: 200,
});

// 11. DebounceLayoutPlugin - 布局防抖
createDebounceLayoutPlugin({
  delay: 150,
});

// 12. RecyclePlugin - DOM 回收复用
createRecyclePlugin({
  poolSize: 50,
});

// 13. BatchRenderPlugin - 批量渲染
createBatchRenderPlugin({
  batchSize: 20,
  interval: 16, // 每帧渲染间隔
});
```

#### 📜 **数据与加载（5 个）**

```typescript
// 14. InfiniteScrollPlugin - 无限滚动
createInfiniteScrollPlugin({
  threshold: 300, // 距离底部多少px触发
  onLoadMore: async (page) => {
    return await fetchMoreItems(page);
  },
  hasMore: true,
});

// 15. PaginationPlugin - 分页
createPaginationPlugin({
  pageSize: 20,
  initialPage: 1,
});

// 16. FilterPlugin - 筛选
createFilterPlugin({
  filter: (item) => item.category === "photo",
  animated: true,
});

// 17. SortPlugin - 排序
createSortPlugin({
  sortBy: "date" | "size" | "name",
  order: "asc" | "desc",
  animated: true,
});

// 18. SearchPlugin - 搜索
createSearchPlugin({
  searchFields: ["title", "tags"],
  debounce: 300,
});
```

#### 🎨 **视觉效果（8 个）**

```typescript
// 19. AnimationPlugin - 进入动画
createAnimationPlugin({
  type: "fade" | "scale" | "slide",
  duration: 300,
  stagger: 50, // 交错延迟
});

// 20. HoverEffectPlugin - 悬停效果
createHoverEffectPlugin({
  scale: 1.05,
  shadow: true,
  overlay: <div>View</div>,
});

// 21. SelectionPlugin - 选择模式
createSelectionPlugin({
  multiple: true,
  showCheckbox: true,
  selectedStyle: { border: "2px solid blue" },
});

// 22. DragSortPlugin - 拖拽排序
createDragSortPlugin({
  handle: ".drag-handle",
  onReorder: (newOrder) => console.log(newOrder),
});

// 23. TransitionPlugin - 布局变化过渡
createTransitionPlugin({
  duration: 300,
  easing: "ease-out",
});

// 24. ParallaxPlugin - 视差效果
createParallaxPlugin({
  speed: 0.5,
});

// 25. SkeletonPlugin - 骨架屏
createSkeletonPlugin({
  count: 10,
  shimmer: true,
});

// 26. LoadingPlugin - 加载状态
createLoadingPlugin({
  spinner: <Spinner />,
  overlay: true,
});
```

#### 💡 **交互功能（7 个）**

```typescript
// 27. LightboxPlugin - 灯箱预览
createLightboxPlugin({
  enableZoom: true,
  enableSwipe: true,
});

// 28. QuickViewPlugin - 快速预览
createQuickViewPlugin({
  trigger: "hover" | "click",
  delay: 500,
});

// 29. ContextMenuPlugin - 右键菜单
createContextMenuPlugin({
  items: [
    { label: "Download", onClick: (item) => {} },
    { label: "Delete", onClick: (item) => {} },
  ],
});

// 30. KeyboardNavigationPlugin - 键盘导航
createKeyboardNavigationPlugin({
  arrows: true,
  enter: "select",
  delete: "remove",
});

// 31. TouchGesturePlugin - 触摸手势
createTouchGesturePlugin({
  swipeToDelete: true,
  pinchToZoom: true,
});

// 32. BookmarkPlugin - 书签/位置记忆
createBookmarkPlugin({
  storageKey: "waterfall-position",
  autoSave: true,
});

// 33. SharePlugin - 分享
createSharePlugin({
  platforms: ["twitter", "facebook", "copy"],
});
```

#### 📊 **监控与分析（5 个）**

```typescript
// 34. PerformanceMonitorPlugin - 性能监控
createPerformanceMonitorPlugin({
  onMetric: (metrics) => {
    console.log("Layout time:", metrics.layoutTime);
  },
});

// 35. ViewportTrackingPlugin - 可见性追踪
createViewportTrackingPlugin({
  threshold: 0.5,
  onVisible: (index) => analytics.track("item_viewed", index),
});

// 36. ClickAnalyticsPlugin - 点击分析
createClickAnalyticsPlugin({
  onItemClick: (item, index) => analytics.track("item_clicked", item),
});

// 37. ScrollDepthPlugin - 滚动深度
createScrollDepthPlugin({
  milestones: [25, 50, 75, 100],
  onMilestone: (depth) => analytics.track("scroll_depth", depth),
});

// 38. ErrorTrackingPlugin - 错误追踪
createErrorTrackingPlugin({
  onError: (error, context) => sentry.captureException(error),
});
```

#### ♿ **可访问性（3 个）**

```typescript
// 39. A11yPlugin - 可访问性增强
createA11yPlugin({
  ariaLabel: true,
  keyboardNav: true,
  focusManagement: true,
});

// 40. AnnouncerPlugin - 屏幕阅读器通知
createAnnouncerPlugin({
  announceNewItems: true,
  announceLoading: true,
});

// 41. ReducedMotionPlugin - 减少动画
createReducedMotionPlugin({
  respectPreference: true,
});
```

### 4️⃣ **使用示例**

```tsx
import {
  WaterfallCore,
  withPlugins,
  createResponsiveColumnsPlugin,
  createVirtualScrollPlugin,
  createInfiniteScrollPlugin,
  createAnimationPlugin,
  createLazyLoadPlugin,
} from 'vane-waterfall';

// 组合插件
const Waterfall = withPlugins(WaterfallCore, [
  createResponsiveColumnsPlugin({
    breakpoints: {
      sm: { width: 640, columns: 2 },
      md: { width: 768, columns: 3 },
      lg: { width: 1024, columns: 4 },
    }
  }),
  createVirtualScrollPlugin({
    overscan: 2,
    estimateItemHeight: 300,
  }),
  createInfiniteScrollPlugin({
    threshold: 300,
    onLoadMore: async (page) => {
      return await fetchImages(page);
    },
  }),
  createAnimationPlugin({
    type: 'fade',
    duration: 300,
    stagger: 50,
  }),
  createLazyLoadPlugin({
    rootMargin: '200px',
  }),
]);

// 使用
function App() {
  const [items, setItems] = useState([...]);

  return (
    <Waterfall
      items={items}
      renderItem={(item, index) => (
        <img src={item.url} alt={item.title} />
      )}
      gap={16}
    />
  );
}
```

### 5️⃣ **架构优势**

✅ **高度解耦** - 核心组件只负责基础布局，功能全部插件化
✅ **按需加载** - Tree-shaking 友好，只打包使用的插件
✅ **易于扩展** - 新功能只需添加新插件，不影响现有代码
✅ **灵活组合** - 插件可以任意组合，满足不同场景需求
✅ **统一体验** - 与现有 LazyLoadImage 插件系统保持一致
✅ **性能优化** - 虚拟滚动、懒加载、缓存等开箱即用

### 6️⃣ **与现有系统集成**

```tsx
// 可以直接复用现有的图片懒加载插件
import {
  createWatermarkPlugin,
  createBlurUpPlugin,
  createRetryOnErrorPlugin,
} from "vane-lazy-image";

const Waterfall = withPlugins(WaterfallCore, [
  createVirtualScrollPlugin(),
  // 瀑布流项使用懒加载图片
  createLazyLoadPlugin({
    imagePlugins: [
      createWatermarkPlugin({ text: "VANE" }),
      createBlurUpPlugin(),
      createRetryOnErrorPlugin(),
    ],
  }),
]);
```

这个设计完全遵循你现有的插件化思路，既保持了架构的一致性，又能充分复用现有的插件生态！你觉得这个方案如何？需要我详细设计某个具体插件的实现吗？

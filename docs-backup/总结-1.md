è¿™æ˜¯ä¸€ä¸ªéå¸¸æœ‰å‰ç»æ€§çš„é—®é¢˜ï¼è®©æˆ‘å…ˆåˆ†æä¸€ä¸‹ç°æœ‰çš„æ‡’åŠ è½½æ’ä»¶ç³»ç»Ÿï¼Œç„¶åä¸ºä½ è®¾è®¡ä¸€ä¸ªç€‘å¸ƒæµçš„æ’ä»¶åŒ–æ–¹æ¡ˆã€‚

[3 tools called]

éå¸¸å¥½çš„æ€è·¯ï¼åŸºäºç°æœ‰çš„æ‡’åŠ è½½æ’ä»¶åŒ–æ¶æ„ï¼Œå®Œå…¨å¯ä»¥æ„å»ºä¸€ä¸ªç€‘å¸ƒæµæ’ä»¶ç³»ç»Ÿã€‚è®©æˆ‘ä¸ºä½ è®¾è®¡ä¸€ä¸ªå®Œæ•´çš„æ–¹æ¡ˆï¼š

## ğŸ“ ç€‘å¸ƒæµæ’ä»¶åŒ–æ¶æ„è®¾è®¡

### 1ï¸âƒ£ **æ ¸å¿ƒç»„ä»¶ï¼šWaterfallCore**

```typescript
// WaterfallCore.tsx - æç®€æ ¸å¿ƒç»„ä»¶

interface WaterfallCoreProps<T = any> {
  // æ•°æ®æº
  items: T[];
  renderItem: (item: T, index: number) => React.ReactNode;

  // å¸ƒå±€é…ç½®
  columns?: number; // åˆ—æ•°ï¼ˆå¯ç”±æ’ä»¶åŠ¨æ€è®¡ç®—ï¼‰
  gap?: number; // é—´è·

  // å®¹å™¨é…ç½®
  containerStyle?: React.CSSProperties;
  containerClassName?: string;

  // ç”Ÿå‘½å‘¨æœŸé’©å­ï¼ˆç”±æ’ä»¶æ³¨å…¥ï¼‰
  onItemMount?: (index: number, element: HTMLElement) => void;
  onItemUnmount?: (index: number) => void;
  onLayoutComplete?: (columnHeights: number[]) => void;
  onScroll?: (scrollTop: number, scrollHeight: number) => void;
  onResize?: (width: number, height: number) => void;

  // ä¾› HOC ä¼ å…¥çš„å¤–éƒ¨å¼•ç”¨
  containerRefExternal?: React.RefObject<HTMLDivElement | null>;
  itemRefsExternal?: React.MutableRefObject<Map<number, HTMLElement>>;
}

interface WaterfallCoreRef {
  relayout: () => void; // é‡æ–°å¸ƒå±€
  scrollToItem: (index: number) => void; // æ»šåŠ¨åˆ°æŒ‡å®šé¡¹
  getItemPosition: (index: number) => { x: number; y: number } | null;
  getColumnHeights: () => number[];
}

// æ ¸å¿ƒèŒè´£ï¼š
// 1. ç»´æŠ¤åŸºç¡€çš„ç€‘å¸ƒæµå¸ƒå±€ç®—æ³•
// 2. ç®¡ç† item ä½ç½®è®¡ç®—
// 3. æä¾› DOM å¼•ç”¨å’ŒçŠ¶æ€
// 4. è§¦å‘ç”Ÿå‘½å‘¨æœŸé’©å­ä¾›æ’ä»¶å“åº”
```

### 2ï¸âƒ£ **æ’ä»¶ç±»å‹å®šä¹‰**

```typescript
// plugins/types.ts

export interface WaterfallPluginContext<T = any> {
  // åŸºç¡€æ•°æ®
  items: T[];
  containerRef: React.RefObject<HTMLDivElement | null>;
  itemRefs: Map<number, HTMLElement>;

  // å¸ƒå±€ä¿¡æ¯
  columns: number;
  gap: number;
  columnHeights: number[];
  itemPositions: Map<
    number,
    { x: number; y: number; width: number; height: number }
  >;

  // è§†å£ä¿¡æ¯
  containerWidth: number;
  containerHeight: number;
  scrollTop: number;
  scrollHeight: number;

  // é…ç½®
  props: WaterfallCoreProps<T>;

  // æ’ä»¶é€šä¿¡
  bus?: PluginBus;
  sharedData?: Map<string, any>;

  // æ€§èƒ½æ•°æ®
  performanceData?: {
    layoutStartTime: number;
    layoutEndTime?: number;
    duration?: number;
    itemCount: number;
  };
}

export interface WaterfallPluginHooks<T = any> {
  // ç”Ÿå‘½å‘¨æœŸé’©å­
  onMount?: (context: WaterfallPluginContext<T>) => void | (() => void);
  onUnmount?: (context: WaterfallPluginContext<T>) => void;

  // å¸ƒå±€é’©å­
  onBeforeLayout?: (
    context: WaterfallPluginContext<T>
  ) => boolean | Promise<boolean>;
  onLayout?: (context: WaterfallPluginContext<T>) => void;
  onLayoutComplete?: (context: WaterfallPluginContext<T>) => void;

  // åˆ—æ•°è®¡ç®—é’©å­ï¼ˆå“åº”å¼æ’ä»¶ä¼šç”¨åˆ°ï¼‰
  calculateColumns?: (context: WaterfallPluginContext<T>) => number | undefined;

  // Item é’©å­
  onItemMount?: (
    context: WaterfallPluginContext<T>,
    index: number,
    element: HTMLElement
  ) => void;
  onItemUnmount?: (context: WaterfallPluginContext<T>, index: number) => void;
  onItemEnterViewport?: (
    context: WaterfallPluginContext<T>,
    index: number
  ) => void;
  onItemLeaveViewport?: (
    context: WaterfallPluginContext<T>,
    index: number
  ) => void;

  // äº¤äº’é’©å­
  onScroll?: (context: WaterfallPluginContext<T>, scrollTop: number) => void;
  onResize?: (
    context: WaterfallPluginContext<T>,
    width: number,
    height: number
  ) => void;

  // æ•°æ®é’©å­
  onItemsChange?: (
    context: WaterfallPluginContext<T>,
    oldItems: T[],
    newItems: T[]
  ) => void;
  onLoadMore?: (
    context: WaterfallPluginContext<T>
  ) => Promise<T[]> | T[] | void;

  // æ¸²æŸ“é’©å­
  renderOverlay?: (context: WaterfallPluginContext<T>) => React.ReactNode;
  renderItemWrapper?: (
    context: WaterfallPluginContext<T>,
    index: number,
    children: React.ReactNode
  ) => React.ReactNode;

  // Props è½¬æ¢
  transformProps?: (props: WaterfallCoreProps<T>) => WaterfallCoreProps<T>;
}

export interface WaterfallPlugin<T = any> {
  name: string;
  version?: string;
  hooks: WaterfallPluginHooks<T>;
  config?: Record<string, any>;
  init?: () => void | Promise<void>;
  destroy?: () => void | Promise<void>;
}
```

### 3ï¸âƒ£ **åŸºç¡€æ’ä»¶åˆ†ç±»**

#### ğŸ“Š **å¸ƒå±€ä¸å“åº”å¼ï¼ˆ5 ä¸ªï¼‰**

```typescript
// 1. ResponsiveColumnsPlugin - å“åº”å¼åˆ—æ•°
createResponsiveColumnsPlugin({
  breakpoints: {
    sm: { width: 640, columns: 2 },
    md: { width: 768, columns: 3 },
    lg: { width: 1024, columns: 4 },
    xl: { width: 1280, columns: 5 },
  },
});

// 2. AutoColumnPlugin - æ ¹æ®å®¹å™¨å®½åº¦è‡ªåŠ¨è®¡ç®—åˆ—æ•°
createAutoColumnPlugin({
  minColumnWidth: 200, // æ¯åˆ—æœ€å°å®½åº¦
  maxColumns: 6,
});

// 3. FixedHeightPlugin - å›ºå®šé«˜åº¦å¸ƒå±€ï¼ˆGridæ¨¡å¼ï¼‰
createFixedHeightPlugin({
  itemHeight: 300,
});

// 4. GapPlugin - åŠ¨æ€é—´è·
createGapPlugin({
  horizontal: 16,
  vertical: 16,
  responsive: {
    sm: 8,
    md: 12,
    lg: 16,
  },
});

// 5. AlignmentPlugin - å¯¹é½ç­–ç•¥
createAlignmentPlugin({
  mode: "shortest" | "balanced" | "sequential", // æœ€çŸ­åˆ—/å¹³è¡¡/é¡ºåº
});
```

#### âš¡ **æ€§èƒ½ä¼˜åŒ–ï¼ˆ8 ä¸ªï¼‰**

```typescript
// 6. VirtualScrollPlugin - è™šæ‹Ÿæ»šåŠ¨
createVirtualScrollPlugin({
  overscan: 3, // ä¸Šä¸‹é¢„æ¸²æŸ“é¡¹æ•°
  estimateItemHeight: 300,
});

// 7. LazyLoadPlugin - æ‡’åŠ è½½ï¼ˆé›†æˆç°æœ‰çš„ LazyLoadImageï¼‰
createLazyLoadPlugin({
  rootMargin: "200px",
  placeholder: <Skeleton />,
});

// 8. PreloadPlugin - é¢„åŠ è½½
createPreloadPlugin({
  preloadCount: 10, // é¢„åŠ è½½ä¸‹æ–¹Né¡¹
  preloadOnIdle: true,
});

// 9. CachePlugin - å¸ƒå±€ç¼“å­˜
createCachePlugin({
  cacheKey: "waterfall-layout",
  ttl: 3600000, // 1å°æ—¶
});

// 10. ThrottlePlugin - æ»šåŠ¨/Resize èŠ‚æµ
createThrottlePlugin({
  scroll: 100, // ms
  resize: 200,
});

// 11. DebounceLayoutPlugin - å¸ƒå±€é˜²æŠ–
createDebounceLayoutPlugin({
  delay: 150,
});

// 12. RecyclePlugin - DOM å›æ”¶å¤ç”¨
createRecyclePlugin({
  poolSize: 50,
});

// 13. BatchRenderPlugin - æ‰¹é‡æ¸²æŸ“
createBatchRenderPlugin({
  batchSize: 20,
  interval: 16, // æ¯å¸§æ¸²æŸ“é—´éš”
});
```

#### ğŸ“œ **æ•°æ®ä¸åŠ è½½ï¼ˆ5 ä¸ªï¼‰**

```typescript
// 14. InfiniteScrollPlugin - æ— é™æ»šåŠ¨
createInfiniteScrollPlugin({
  threshold: 300, // è·ç¦»åº•éƒ¨å¤šå°‘pxè§¦å‘
  onLoadMore: async (page) => {
    return await fetchMoreItems(page);
  },
  hasMore: true,
});

// 15. PaginationPlugin - åˆ†é¡µ
createPaginationPlugin({
  pageSize: 20,
  initialPage: 1,
});

// 16. FilterPlugin - ç­›é€‰
createFilterPlugin({
  filter: (item) => item.category === "photo",
  animated: true,
});

// 17. SortPlugin - æ’åº
createSortPlugin({
  sortBy: "date" | "size" | "name",
  order: "asc" | "desc",
  animated: true,
});

// 18. SearchPlugin - æœç´¢
createSearchPlugin({
  searchFields: ["title", "tags"],
  debounce: 300,
});
```

#### ğŸ¨ **è§†è§‰æ•ˆæœï¼ˆ8 ä¸ªï¼‰**

```typescript
// 19. AnimationPlugin - è¿›å…¥åŠ¨ç”»
createAnimationPlugin({
  type: "fade" | "scale" | "slide",
  duration: 300,
  stagger: 50, // äº¤é”™å»¶è¿Ÿ
});

// 20. HoverEffectPlugin - æ‚¬åœæ•ˆæœ
createHoverEffectPlugin({
  scale: 1.05,
  shadow: true,
  overlay: <div>View</div>,
});

// 21. SelectionPlugin - é€‰æ‹©æ¨¡å¼
createSelectionPlugin({
  multiple: true,
  showCheckbox: true,
  selectedStyle: { border: "2px solid blue" },
});

// 22. DragSortPlugin - æ‹–æ‹½æ’åº
createDragSortPlugin({
  handle: ".drag-handle",
  onReorder: (newOrder) => console.log(newOrder),
});

// 23. TransitionPlugin - å¸ƒå±€å˜åŒ–è¿‡æ¸¡
createTransitionPlugin({
  duration: 300,
  easing: "ease-out",
});

// 24. ParallaxPlugin - è§†å·®æ•ˆæœ
createParallaxPlugin({
  speed: 0.5,
});

// 25. SkeletonPlugin - éª¨æ¶å±
createSkeletonPlugin({
  count: 10,
  shimmer: true,
});

// 26. LoadingPlugin - åŠ è½½çŠ¶æ€
createLoadingPlugin({
  spinner: <Spinner />,
  overlay: true,
});
```

#### ğŸ’¡ **äº¤äº’åŠŸèƒ½ï¼ˆ7 ä¸ªï¼‰**

```typescript
// 27. LightboxPlugin - ç¯ç®±é¢„è§ˆ
createLightboxPlugin({
  enableZoom: true,
  enableSwipe: true,
});

// 28. QuickViewPlugin - å¿«é€Ÿé¢„è§ˆ
createQuickViewPlugin({
  trigger: "hover" | "click",
  delay: 500,
});

// 29. ContextMenuPlugin - å³é”®èœå•
createContextMenuPlugin({
  items: [
    { label: "Download", onClick: (item) => {} },
    { label: "Delete", onClick: (item) => {} },
  ],
});

// 30. KeyboardNavigationPlugin - é”®ç›˜å¯¼èˆª
createKeyboardNavigationPlugin({
  arrows: true,
  enter: "select",
  delete: "remove",
});

// 31. TouchGesturePlugin - è§¦æ‘¸æ‰‹åŠ¿
createTouchGesturePlugin({
  swipeToDelete: true,
  pinchToZoom: true,
});

// 32. BookmarkPlugin - ä¹¦ç­¾/ä½ç½®è®°å¿†
createBookmarkPlugin({
  storageKey: "waterfall-position",
  autoSave: true,
});

// 33. SharePlugin - åˆ†äº«
createSharePlugin({
  platforms: ["twitter", "facebook", "copy"],
});
```

#### ğŸ“Š **ç›‘æ§ä¸åˆ†æï¼ˆ5 ä¸ªï¼‰**

```typescript
// 34. PerformanceMonitorPlugin - æ€§èƒ½ç›‘æ§
createPerformanceMonitorPlugin({
  onMetric: (metrics) => {
    console.log("Layout time:", metrics.layoutTime);
  },
});

// 35. ViewportTrackingPlugin - å¯è§æ€§è¿½è¸ª
createViewportTrackingPlugin({
  threshold: 0.5,
  onVisible: (index) => analytics.track("item_viewed", index),
});

// 36. ClickAnalyticsPlugin - ç‚¹å‡»åˆ†æ
createClickAnalyticsPlugin({
  onItemClick: (item, index) => analytics.track("item_clicked", item),
});

// 37. ScrollDepthPlugin - æ»šåŠ¨æ·±åº¦
createScrollDepthPlugin({
  milestones: [25, 50, 75, 100],
  onMilestone: (depth) => analytics.track("scroll_depth", depth),
});

// 38. ErrorTrackingPlugin - é”™è¯¯è¿½è¸ª
createErrorTrackingPlugin({
  onError: (error, context) => sentry.captureException(error),
});
```

#### â™¿ **å¯è®¿é—®æ€§ï¼ˆ3 ä¸ªï¼‰**

```typescript
// 39. A11yPlugin - å¯è®¿é—®æ€§å¢å¼º
createA11yPlugin({
  ariaLabel: true,
  keyboardNav: true,
  focusManagement: true,
});

// 40. AnnouncerPlugin - å±å¹•é˜…è¯»å™¨é€šçŸ¥
createAnnouncerPlugin({
  announceNewItems: true,
  announceLoading: true,
});

// 41. ReducedMotionPlugin - å‡å°‘åŠ¨ç”»
createReducedMotionPlugin({
  respectPreference: true,
});
```

### 4ï¸âƒ£ **ä½¿ç”¨ç¤ºä¾‹**

```tsx
import {
  WaterfallCore,
  withPlugins,
  createResponsiveColumnsPlugin,
  createVirtualScrollPlugin,
  createInfiniteScrollPlugin,
  createAnimationPlugin,
  createLazyLoadPlugin,
} from 'vane-waterfall';

// ç»„åˆæ’ä»¶
const Waterfall = withPlugins(WaterfallCore, [
  createResponsiveColumnsPlugin({
    breakpoints: {
      sm: { width: 640, columns: 2 },
      md: { width: 768, columns: 3 },
      lg: { width: 1024, columns: 4 },
    }
  }),
  createVirtualScrollPlugin({
    overscan: 2,
    estimateItemHeight: 300,
  }),
  createInfiniteScrollPlugin({
    threshold: 300,
    onLoadMore: async (page) => {
      return await fetchImages(page);
    },
  }),
  createAnimationPlugin({
    type: 'fade',
    duration: 300,
    stagger: 50,
  }),
  createLazyLoadPlugin({
    rootMargin: '200px',
  }),
]);

// ä½¿ç”¨
function App() {
  const [items, setItems] = useState([...]);

  return (
    <Waterfall
      items={items}
      renderItem={(item, index) => (
        <img src={item.url} alt={item.title} />
      )}
      gap={16}
    />
  );
}
```

### 5ï¸âƒ£ **æ¶æ„ä¼˜åŠ¿**

âœ… **é«˜åº¦è§£è€¦** - æ ¸å¿ƒç»„ä»¶åªè´Ÿè´£åŸºç¡€å¸ƒå±€ï¼ŒåŠŸèƒ½å…¨éƒ¨æ’ä»¶åŒ–
âœ… **æŒ‰éœ€åŠ è½½** - Tree-shaking å‹å¥½ï¼Œåªæ‰“åŒ…ä½¿ç”¨çš„æ’ä»¶
âœ… **æ˜“äºæ‰©å±•** - æ–°åŠŸèƒ½åªéœ€æ·»åŠ æ–°æ’ä»¶ï¼Œä¸å½±å“ç°æœ‰ä»£ç 
âœ… **çµæ´»ç»„åˆ** - æ’ä»¶å¯ä»¥ä»»æ„ç»„åˆï¼Œæ»¡è¶³ä¸åŒåœºæ™¯éœ€æ±‚
âœ… **ç»Ÿä¸€ä½“éªŒ** - ä¸ç°æœ‰ LazyLoadImage æ’ä»¶ç³»ç»Ÿä¿æŒä¸€è‡´
âœ… **æ€§èƒ½ä¼˜åŒ–** - è™šæ‹Ÿæ»šåŠ¨ã€æ‡’åŠ è½½ã€ç¼“å­˜ç­‰å¼€ç®±å³ç”¨

### 6ï¸âƒ£ **ä¸ç°æœ‰ç³»ç»Ÿé›†æˆ**

```tsx
// å¯ä»¥ç›´æ¥å¤ç”¨ç°æœ‰çš„å›¾ç‰‡æ‡’åŠ è½½æ’ä»¶
import {
  createWatermarkPlugin,
  createBlurUpPlugin,
  createRetryOnErrorPlugin,
} from "vane-lazy-image";

const Waterfall = withPlugins(WaterfallCore, [
  createVirtualScrollPlugin(),
  // ç€‘å¸ƒæµé¡¹ä½¿ç”¨æ‡’åŠ è½½å›¾ç‰‡
  createLazyLoadPlugin({
    imagePlugins: [
      createWatermarkPlugin({ text: "VANE" }),
      createBlurUpPlugin(),
      createRetryOnErrorPlugin(),
    ],
  }),
]);
```

è¿™ä¸ªè®¾è®¡å®Œå…¨éµå¾ªä½ ç°æœ‰çš„æ’ä»¶åŒ–æ€è·¯ï¼Œæ—¢ä¿æŒäº†æ¶æ„çš„ä¸€è‡´æ€§ï¼Œåˆèƒ½å……åˆ†å¤ç”¨ç°æœ‰çš„æ’ä»¶ç”Ÿæ€ï¼ä½ è§‰å¾—è¿™ä¸ªæ–¹æ¡ˆå¦‚ä½•ï¼Ÿéœ€è¦æˆ‘è¯¦ç»†è®¾è®¡æŸä¸ªå…·ä½“æ’ä»¶çš„å®ç°å—ï¼Ÿ
